<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹±è¯­å°ç‹— Â· æœ€ç»ˆå®Œæ•´ç‰ˆ</title>

<style>
/* ===== CSS æ ·å¼éƒ¨åˆ† ===== */
body{
  margin:0;
  font-family:"Comic Sans MS","PingFang SC",sans-serif;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  min-height:100vh;
  text-align:center;
  padding:20px 0;
  color:#333;
  -webkit-tap-highlight-color: transparent; /* ç§»åŠ¨ç«¯ç‚¹å‡»é«˜äº®å»é™¤ */
}
h1{margin:8px;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
.hidden{display:none!important}

/* å¡ç‰‡å®¹å™¨ */
.card{
  background:#fff;border-radius:18px;
  padding:20px;max-width:440px;
  margin:10px auto;
  box-shadow:0 8px 24px rgba(0,0,0,.2);
  width: 90%; /* é€‚é…æ‰‹æœºå®½åº¦ */
  box-sizing: border-box;
}

/* æŒ‰é’®æ ·å¼ */
button{
  width:100%;padding:14px;
  margin:6px 0;font-size:16px;
  border:none;border-radius:12px;
  background:#4caf50;color:#fff;
  cursor:pointer;
  transition:all 0.2s;
  font-weight:bold;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
button:active{transform:scale(0.98);box-shadow:0 2px 4px rgba(0,0,0,0.1)}
.secondary{background:#2196f3}
.shop{background:#ff9800}
.back{background:#9e9e9e}
.design{background:#e91e63}
.achievement{background:#9c27b0}

/* è¾“å…¥æ¡†æ§ä»¶ */
input[type=range]{width:90%;margin:8px 0}
input[type=color]{margin:6px;width:60px;height:40px;border:none;border-radius:8px;cursor:pointer}
input[type=text]{
  width:85%;padding:12px;margin:8px 0;
  border:2px solid #ddd;border-radius:8px;
  font-size:16px;text-align:center;
}

/* å°ç‹— SVG å®¹å™¨ */
.pet-wrap{
  position:relative;
  margin:10px auto;
  width:280px; height:340px;
  display:flex; justify-content:center; align-items:center;
}
.pet{
  width:100%; height:100%;
  transition:transform .3s;
  filter:drop-shadow(0 4px 8px rgba(0,0,0,0.15));
}
.pet.happy{animation: jump 0.5s ease;}
.pet.sick{filter:grayscale(0.8) sepia(0.2);}

@keyframes jump {
  0% { transform: translateY(0); }
  50% { transform: translateY(-20px) scale(1.1); }
  100% { transform: translateY(0); }
}

/* å¡«ç©ºé¢˜æ ·å¼ */
.blank{
  display:inline-block; width:24px; border-bottom:3px solid #333;
  margin:0 2px; animation:pulse .8s infinite alternate;
}
@keyframes pulse{from{opacity:.4} to{opacity:1}}
.letter-btn{
  width:auto; display:inline-block; margin:4px;
  padding:10px 16px; font-size:18px; font-weight:bold;
  background: #673ab7;
}

/* çŠ¶æ€æ¡ */
#status-bar { margin: 10px 0; }
.badge {
  background:rgba(255,255,255,0.95);
  display:inline-block; padding:8px 16px;
  border-radius:20px; margin:4px;
  font-weight:bold; color:#333; font-size: 14px;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
}

/* è®¾è®¡åº“ç½‘æ ¼ */
.design-gallery{
  display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr));
  gap:10px; margin:15px 0; max-height:300px; overflow-y:auto;
}
.design-item{
  background:#f5f5f5; border-radius:8px; padding:8px;
  cursor:pointer; border:2px solid transparent;
}
.design-item:hover{border-color:#e91e63;}

/* PK åŒºåŸŸ */
.battle-zone{
  background:#f0f4f8; border-radius:12px; padding:15px;
  display:flex; justify-content: space-around; align-items: center;
  margin-bottom: 15px;
}
.vs-text{ font-size: 24px; font-weight: 900; color: #ff5722; font-style: italic; }

/* ç»Ÿè®¡è¡Œ */
.stat-row{
  display:flex; justify-content:space-between;
  padding:10px; border-bottom:1px solid #eee;
}
</style>
</head>

<body>

<h1>ğŸ¶ æˆ‘çš„è‹±è¯­å°ç‹—</h1>

<div class="pet-wrap">
<svg id="dog" class="pet" viewBox="0 0 200 360">
  <g id="dogBodyGroup">
    <ellipse cx="100" cy="200" rx="65" ry="90" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="3"/>
    <circle cx="100" cy="100" r="55" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="3"/>
    
    <g id="earL_g" transform-origin="55 65">
      <ellipse cx="55" cy="65" rx="18" ry="38" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
      <ellipse cx="55" cy="70" rx="10" ry="20" fill="#ffb6c1"/>
    </g>
    <g id="earR_g" transform-origin="145 65">
      <ellipse cx="145" cy="65" rx="18" ry="38" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
      <ellipse cx="145" cy="70" rx="10" ry="20" fill="#ffb6c1"/>
    </g>
    
    <g id="eyeL_g" transform-origin="85 95">
      <ellipse cx="85" cy="95" rx="8" ry="10" fill="#fff" stroke="#333" stroke-width="1"/>
      <circle cx="85" cy="97" r="5" fill="#000"/>
    </g>
    <g id="eyeR_g" transform-origin="115 95">
      <ellipse cx="115" cy="95" rx="8" ry="10" fill="#fff" stroke="#333" stroke-width="1"/>
      <circle cx="115" cy="97" r="5" fill="#000"/>
    </g>
    
    <ellipse cx="100" cy="115" rx="8" ry="6" fill="#000"/>
    <path d="M88 125 Q100 135 112 125" stroke="#000" stroke-width="3" fill="none"/>
    
    <rect x="70" y="270" width="12" height="70" rx="6" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
    <rect x="118" y="270" width="12" height="70" rx="6" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
    <rect x="55" y="270" width="12" height="70" rx="6" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
    <rect x="133" y="270" width="12" height="70" rx="6" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
    
    <path d="M155 210 Q175 200 180 180" stroke="var(--dogColor,#fff)" stroke-width="15" fill="none" stroke-linecap="round"/>
  </g>
</svg>
</div>

<div id="status-bar">
  <div class="badge" id="scoreBadge">ğŸ’° 0</div>
  <div class="badge" id="streakBadge">ğŸ”¥ 0</div>
  <div class="badge" id="healthBadge">â¤ï¸ å¥åº·</div>
</div>

<div class="card" id="home">
  <button onclick="app.startStudy()">ğŸ“˜ å­¦ä¹ æ¨¡å¼</button>
  <button class="secondary" onclick="app.startCheckup()">ğŸ¥ å°ç‹—ä½“æ£€ (10é¢˜)</button>
  <button onclick="app.startPK()">âš”ï¸ å¥½å‹ PK</button>
  <button class="shop" onclick="app.openShop()">ğŸ’Š è¯å“å•†åº—</button>
  <button class="design" onclick="app.openDesign()">ğŸ¨ è®¾è®¡å°ç‹—</button>
  <button class="achievement" onclick="app.openAchievements()">ğŸ† æˆå°±ç³»ç»Ÿ</button>
  <button class="secondary" onclick="app.openStats()">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</button>
</div>

<div class="card hidden" id="quiz">
  <h3 id="quizTitle"></h3>
  <div id="questionText" style="font-size:18px;margin:20px 0;color:#555;"></div>
  
  <div id="choiceArea"></div>
  
  <div id="spellArea" class="hidden">
    <input type="text" id="spellInput" placeholder="è¾“å…¥å•è¯...">
    <button onclick="app.checkSpell()">æäº¤</button>
  </div>

  <div id="blankArea" class="hidden">
    <div id="blankWordDisplay" style="font-size:24px;margin:15px;letter-spacing:2px"></div>
    <div id="letterButtons"></div>
  </div>

  <button class="back" onclick="app.goHome()">â¬… è¿”å›ä¸»é¡µ</button>
</div>

<div class="card hidden" id="pkPage">
  <h3>âš”ï¸ PK å¯¹æˆ˜</h3>
  <div class="battle-zone">
    <div>
      <div>æˆ‘</div>
      <div style="font-size:20px;font-weight:bold" id="pkMyScore">0</div>
    </div>
    <div class="vs-text">VS</div>
    <div>
      <div>å¯¹æ‰‹</div>
      <div style="font-size:20px;font-weight:bold" id="pkOpScore">0</div>
    </div>
  </div>
  <div id="pkQuestion" style="margin:10px 0"></div>
  <div id="pkOptions"></div>
  <div id="pkMessage" style="color:red;font-weight:bold;height:24px"></div>
  <button class="back" onclick="app.goHome()">é€€å‡º PK</button>
</div>

<div class="card hidden" id="shopPage">
  <h3 style="color:#ff9800">ğŸ’Š è¯å“å•†åº— (5ç§¯åˆ†/ä¸ª)</h3>
  <div id="medicineList"></div>
  <button class="back" onclick="app.goHome()">â¬… è¿”å›</button>
</div>

<div class="card hidden" id="designPage">
  <h3 style="color:#e91e63">ğŸ¨ è®¾è®¡å°ç‹— (ä¿å­˜éœ€2ç§¯åˆ†)</h3>
  <div style="text-align:left">
    <label>æ¯›è‰²: <input type="color" id="set_color" oninput="app.previewDesign()"></label><br>
    <label>å·¦è€³: <input type="range" id="set_earL" min="-45" max="45" oninput="app.previewDesign()"></label><br>
    <label>å³è€³: <input type="range" id="set_earR" min="-45" max="45" oninput="app.previewDesign()"></label><br>
    <label>å·¦çœ¼: <input type="range" id="set_eyeL" min="-20" max="20" oninput="app.previewDesign()"></label><br>
    <label>å³çœ¼: <input type="range" id="set_eyeR" min="-20" max="20" oninput="app.previewDesign()"></label><br>
    <input type="text" id="designName" placeholder="è®¾è®¡åç§°">
  </div>
  <button onclick="app.saveDesign()">ğŸ’¾ ä¿å­˜å¹¶åº”ç”¨</button>
  <button class="secondary" onclick="app.showGallery()">ğŸ“‚ æˆ‘çš„è®¾è®¡åº“</button>
  <button class="back" onclick="app.goHome()">â¬… è¿”å›</button>
</div>

<div class="card hidden" id="galleryPage">
  <h3>ğŸ“‚ æˆ‘çš„è®¾è®¡åº“</h3>
  <div id="galleryGrid" class="design-gallery"></div>
  <button class="back" onclick="app.openDesign()">â¬… è¿”å›è®¾è®¡</button>
</div>

<div class="card hidden" id="achievementPage">
  <h3 style="color:#9c27b0">ğŸ† æˆå°±å¢™</h3>
  <div id="achieveList" style="display:grid;grid-template-columns:1fr 1fr;gap:10px"></div>
  <button class="back" onclick="app.goHome()">â¬… è¿”å›</button>
</div>

<div class="card hidden" id="statsPage">
  <h3 style="color:#2196f3">ğŸ“Š å­¦ä¹ æ•°æ®</h3>
  <div id="statsContent"></div>
  <button style="background:#f44336" onclick="app.resetData()">ğŸ—‘ï¸ é‡ç½®æ‰€æœ‰æ•°æ®</button>
  <button class="back" onclick="app.goHome()">â¬… è¿”å›</button>
</div>

<script>
/**
 * è‹±è¯­å°ç‹— - æ ¸å¿ƒé€»è¾‘ (ä¿®å¤ç‰ˆ)
 * ç¡®ä¿è¿™æ®µ JS ä»£ç æ˜¯å®Œæ•´çš„ï¼Œæ²¡æœ‰ä¸­æ–­
 */

// 1. æ•°æ®å®šä¹‰
const WORDS = {
  headache: [["practice","ç»ƒä¹ "],["brain","å¤§è„‘"],["pain","ç–¼ç—›"],["rest","ä¼‘æ¯"]],
  toothache: [["tooth","ç‰™é½¿"],["candy","ç³–æœ"],["brush","åˆ·"],["dentist","ç‰™åŒ»"]],
  cold: [["cold","æ„Ÿå†’"],["hot","çƒ­"],["water","æ°´"],["mask","å£ç½©"]],
  hurt: [["hurt","å—ä¼¤"],["hospital","åŒ»é™¢"],["careful","å°å¿ƒ"],["run","è·‘"]],
  general: [
    ["prepare", "å‡†å¤‡"],
  ["healthy", "å¥åº·çš„"],
  ["weekly", "ä¸€å‘¨çš„"],
  ["stretch", "æ‹‰ä¼¸"],
  ["schedule", "å®‰æ’è¡¨"],
  ["second", "ç¬¬äºŒ/ç§’"],
  ["add", "å¢åŠ "],
  ["breathe", "å‘¼å¸"],
  ["warm-up", "çƒ­èº«"],
  ["calm", "å¹³é™çš„"],
  ["present", "å±•ç¤º"],
  ["character", "è§’è‰²"],
  ["start", "å¼€å§‹"],
  ["poor", "è´«ç©·çš„"],
  ["begin", "å¼€å§‹"],
  ["porridge", "ç²¥"],
  ["country", "å›½å®¶"],
  ["wild", "é‡ç”Ÿçš„"],
  ["brilliant", "èªæ˜çš„"],
  ["collect", "æ”¶é›†"],
  ["sense", "æ„Ÿè§‰"],
  ["firewood", "æŸ´ç«"],
  ["balance", "å¹³è¡¡"],
  ["knock", "æ•²é—¨"],
  ["control", "æ§åˆ¶"],
  ["roar", "å’†å“®"],
  ["complicated", "å¤æ‚çš„"],
  ["greedy", "è´ªå©ªçš„"],
  ["organ", "å™¨å®˜"],
  ["belong", "å±äº"],
  ["without", "æ²¡æœ‰"],
  ["dangerous", "å±é™©çš„"],
  ["brain", "å¤§è„‘"],
  ["cough", "å’³"],
  ["stomach", "èƒƒ"],
  ["hurt", "å—ä¼¤"],
  ["backache", "èƒŒç—›"],
  ["sore throat", "å—“å­ç—›"],
  ["headache", "å¤´ç—›"],
  ["temperature", "å‘çƒ­"],
  ["stomach-ache", "èƒƒç—›"],
  ["toothache", "ç‰™ç—›"],
  ["practice", "ç»ƒä¹ "],["video", "è§†é¢‘"],
  ["fantastic", "å¥½æäº†"],
  ["nature", "è‡ªç„¶"],
  ["exciting", "å…´å¥‹çš„"],
  ["natural", "è‡ªç„¶çš„"],
  ["ago", "ä»¥å‰"],
  ["naturally", "è‡ªç„¶åœ°"],
  ["town", "é•‡"],
  ["unit", "å•å…ƒ"],
  ["cry", "å“­"],
  ["design", "è®¾è®¡"],
  ["leave", "ç¦»å¼€"],
  ["place", "åœ°æ–¹"],
  ["travel", "æ—…æ¸¸"],
  ["create", "åˆ›é€ "],
  ["until", "ç›´åˆ°"],
  ["adventure", "å†’é™©"],
  ["terrible", "å¯æ€•çš„"],
  ["map", "åœ°å›¾"],
  ["plan", "è®¡åˆ’"],
  ["area", "åœ°åŒº"],
  ["gold", "é‡‘å­"],
  ["golden", "é‡‘è‰²çš„"],
  ["invent", "å‘æ˜"],
  ["costume", "æœè£…"],
  ["insect", "æ˜†è™«"],
  ["catch", "æŠ“"],
  ["tiny", "æå°çš„"],
  ["palace", "ç‹å®«"],
  ["land", "åœŸåœ°"],
  ["use", "ä½¿ç”¨"],
  ["large", "å¤§çš„"],
  ["find", "æ‰¾åˆ°"],
  ["island", "å²›"],
  ["touch", "è§¦æ‘¸"],
  ["think", "æƒ³"]
  ]
};

const DISEASES = {
  headache: "å¤´ç—›", toothache: "ç‰™ç—›", cold: "æ„Ÿå†’", hurt: "å¤–ä¼¤"
};

const ACHIEVEMENTS = [
  {id:"first", name:"åˆå‡ºèŒ…åº", desc:"ç­”å¯¹ç¬¬1é¢˜", check:s=>s.correct>=1},
  {id:"rich", name:"å°å¯Œç¿", desc:"æ‹¥æœ‰20ç§¯åˆ†", check:s=>s.score>=20},
  {id:"streak10", name:"è¿èƒœå¤§å¸ˆ", desc:"è¿ç»­ç­”å¯¹10é¢˜", check:s=>s.streak>=10},
  {id:"doctor", name:"ç¥åŒ»", desc:"æ²»æ„ˆå°ç‹—3æ¬¡", check:s=>s.cured>=3},
  {id:"designer", name:"è‰ºæœ¯å®¶", desc:"ä¿å­˜3ä¸ªè®¾è®¡", check:s=>s.designs.length>=3}
];

// 2. åº”ç”¨ç¨‹åºå¯¹è±¡ (å‘½åç©ºé—´)
const app = {
  state: {
    score: 0,
    mood: "healthy", // healthy, sick
    disease: null,
    streak: 0,
    maxStreak: 0,
    correct: 0,
    total: 0,
    cured: 0,
    designs: [],
    unlockedAch: [],
    style: {color:"#ffffff", earL:0, earR:0, eyeL:0, eyeR:0}
  },

  // è¿è¡Œæ—¶ä¸´æ—¶å˜é‡
  temp: {
    mode: null, // study, checkup, pk
    currentWord: null,
    qCount: 0,
    pkRound: 0,
    pkMyScore: 0,
    pkOpScore: 0
  },

  init: function() {
    // è¯»å–å­˜æ¡£
    const save = localStorage.getItem("DOG_GAME_V2");
    if(save) {
      try { this.state = Object.assign(this.state, JSON.parse(save)); } 
      catch(e) { console.error("å­˜æ¡£æŸå"); }
    }
    this.updateUI();
    this.applyDogStyle();
  },

  save: function() {
    localStorage.setItem("DOG_GAME_V2", JSON.stringify(this.state));
    this.updateUI();
  },

  // --- å¯¼èˆªé€»è¾‘ ---
  goHome: function() {
    document.querySelectorAll(".card").forEach(el => el.classList.add("hidden"));
    document.getElementById("home").classList.remove("hidden");
    this.updateUI();
  },

  // --- å­¦ä¹ /ä½“æ£€é€»è¾‘ ---
  startStudy: function() {
    this.temp.mode = "study";
    this.showQuizPage("ğŸ“˜ å­¦ä¹ æ¨¡å¼");
    this.nextQuestion();
  },

  startCheckup: function() {
    if(this.state.mood === "healthy") return alert("å°ç‹—å¾ˆå¥åº·ï¼Œä¸éœ€è¦ä½“æ£€ï¼");
    this.temp.mode = "checkup";
    this.temp.qCount = 0;
    this.showQuizPage(`ğŸ¥ ä½“æ£€ä¸­ (${DISEASES[this.state.disease]})`);
    this.nextQuestion();
  },

  showQuizPage: function(title) {
    document.querySelectorAll(".card").forEach(el => el.classList.add("hidden"));
    document.getElementById("quiz").classList.remove("hidden");
    document.getElementById("quizTitle").innerText = title;
  },

  nextQuestion: function() {
    // è·å–è¯åº“
    let pool = [];
    if(this.temp.mode === "checkup" && this.state.disease) {
      pool = WORDS[this.state.disease] || WORDS.general;
    } else {
      Object.values(WORDS).forEach(arr => pool.push(...arr));
    }
    
    // éšæœºé€‰è¯
    const pair = pool[Math.floor(Math.random() * pool.length)];
    this.temp.currentWord = {en: pair[0], cn: pair[1]};
    
    // éšæœºé¢˜å‹ (0:è‹±é€‰æ±‰, 1:æ±‰é€‰è‹±, 2:æ‹¼å†™, 3:å¡«ç©º)
    const type = Math.floor(Math.random() * 4);
    
    // é‡ç½®ç•Œé¢
    const qText = document.getElementById("questionText");
    const cArea = document.getElementById("choiceArea");
    const sArea = document.getElementById("spellArea");
    const bArea = document.getElementById("blankArea");
    cArea.innerHTML = "";
    sArea.classList.add("hidden");
    bArea.classList.add("hidden");

    // ç”Ÿæˆé¢˜ç›®
    if(type === 0 || type === 1) {
      // é€‰æ‹©é¢˜
      const isEnToCn = (type === 0);
      qText.innerText = isEnToCn ? `"${this.temp.currentWord.en}" çš„æ„æ€æ˜¯ï¼Ÿ` : `"${this.temp.currentWord.cn}" çš„è‹±æ–‡æ˜¯ï¼Ÿ`;
      
      const correctAns = isEnToCn ? this.temp.currentWord.cn : this.temp.currentWord.en;
      // å¹²æ‰°é¡¹
      let wrong = pool[Math.floor(Math.random() * pool.length)];
      while(wrong[0] === this.temp.currentWord.en) wrong = pool[Math.floor(Math.random() * pool.length)];
      const wrongAns = isEnToCn ? wrong[1] : wrong[0];
      
      const opts = [correctAns, wrongAns].sort(() => Math.random() - 0.5);
      
      opts.forEach(opt => {
        const btn = document.createElement("button");
        btn.innerText = opt;
        btn.onclick = () => app.handleAnswer(opt === correctAns);
        cArea.appendChild(btn);
      });
    } 
    else if(type === 2) {
      // æ‹¼å†™é¢˜
      qText.innerText = `è¯·æ‹¼å†™: ${this.temp.currentWord.cn}`;
      sArea.classList.remove("hidden");
      document.getElementById("spellInput").value = "";
    }
    else {
      // å¡«ç©ºé¢˜
      qText.innerText = "è¡¥å…¨å•è¯";
      bArea.classList.remove("hidden");
      const word = this.temp.currentWord.en;
      const blankIdx = Math.floor(Math.random() * word.length);
      this.temp.blankAns = word[blankIdx];
      
      document.getElementById("blankWordDisplay").innerHTML = word.split("").map((c,i) => 
        i === blankIdx ? '<span class="blank"></span>' : c
      ).join("");
      
      const letters = document.getElementById("letterButtons");
      letters.innerHTML = "";
      // ç”Ÿæˆé€‰é¡¹
      const opts = [this.temp.blankAns, String.fromCharCode(97+Math.floor(Math.random()*26))].sort(() => Math.random()-0.5);
      opts.forEach(l => {
        const btn = document.createElement("button");
        btn.className = "letter-btn";
        btn.innerText = l;
        btn.onclick = () => app.handleAnswer(l === app.temp.blankAns);
        letters.appendChild(btn);
      });
    }
  },

  checkSpell: function() {
    const val = document.getElementById("spellInput").value.trim().toLowerCase();
    this.handleAnswer(val === this.temp.currentWord.en);
  },

  handleAnswer: function(isCorrect) {
    this.state.total++;
    
    if(isCorrect) {
      this.state.score++;
      this.state.streak++;
      this.state.correct++;
      if(this.state.streak > this.state.maxStreak) this.state.maxStreak = this.state.streak;
      document.getElementById("dog").classList.add("happy");
      setTimeout(() => document.getElementById("dog").classList.remove("happy"), 500);
      alert("âœ… ç­”å¯¹äº†ï¼");
    } else {
      this.state.streak = 0;
      alert(`âŒ ç­”é”™äº†ï¼\n${this.temp.currentWord.en} = ${this.temp.currentWord.cn}`);
      
      // ç”Ÿç—…é€»è¾‘
      if(this.state.mood === "healthy" && Math.random() < 0.3) {
        this.state.mood = "sick";
        const dKeys = Object.keys(DISEASES);
        this.state.disease = dKeys[Math.floor(Math.random() * dKeys.length)];
        alert(`ğŸ˜± ç³Ÿç³•ï¼å°ç‹—ç”Ÿç—…äº†: ${DISEASES[this.state.disease]}`);
      }
    }

    this.checkAchievements();
    this.save();

    // ä½“æ£€æ¨¡å¼æ£€æµ‹
    if(this.temp.mode === "checkup") {
      this.temp.qCount++;
      if(this.temp.qCount >= 10) {
        if(this.state.streak >= 8) { // æœ€è¿‘è¿ç»­ç­”å¯¹ç®—é€šè¿‡
          this.state.mood = "healthy";
          this.state.disease = null;
          this.state.cured++;
          alert("ğŸ‰ ä½“æ£€é€šè¿‡ï¼Œå°ç‹—åº·å¤äº†ï¼");
        } else {
          alert("âš ï¸ ä½“æ£€æœªé€šè¿‡ï¼Œè¯·å†è¯•ä¸€æ¬¡æˆ–å»å•†åº—ä¹°è¯ã€‚");
        }
        this.goHome();
      } else {
        this.nextQuestion();
      }
    } else {
      this.nextQuestion();
    }
  },

  // --- PK é€»è¾‘ ---
  startPK: function() {
    document.querySelectorAll(".card").forEach(el => el.classList.add("hidden"));
    document.getElementById("pkPage").classList.remove("hidden");
    this.temp.pkRound = 0;
    this.temp.pkMyScore = 0;
    this.temp.pkOpScore = 0;
    this.nextPKRound();
  },

  nextPKRound: function() {
    if(this.temp.pkRound >= 5) {
      // ç»“ç®—
      let res = "ğŸ¤ å¹³å±€";
      if(this.temp.pkMyScore > this.temp.pkOpScore) {
        res = "ğŸ† ä½ èµ¢äº†ï¼(+5åˆ†)";
        this.state.score += 5;
      } else if(this.temp.pkMyScore < this.temp.pkOpScore) {
        res = "ğŸ˜¢ ä½ è¾“äº†...";
      }
      document.getElementById("pkQuestion").innerText = res;
      document.getElementById("pkOptions").innerHTML = "";
      this.save();
      return;
    }

    this.temp.pkRound++;
    // æ›´æ–°åˆ†æ•°æ¿
    document.getElementById("pkMyScore").innerText = this.temp.pkMyScore;
    document.getElementById("pkOpScore").innerText = this.temp.pkOpScore;
    
    // å‡ºé¢˜
    const pool = WORDS.general;
    const pair = pool[Math.floor(Math.random() * pool.length)];
    const wrong = pool[Math.floor(Math.random() * pool.length)];
    
    document.getElementById("pkQuestion").innerText = `ç¬¬ ${this.temp.pkRound}/5 è½®: ${pair[0]} æ„æ€æ˜¯?`;
    
    const opts = [pair[1], wrong[1]].sort(()=>Math.random()-0.5);
    const div = document.getElementById("pkOptions");
    div.innerHTML = "";
    
    opts.forEach(o => {
      const btn = document.createElement("button");
      btn.innerText = o;
      btn.onclick = () => {
        // ç©å®¶å¾—åˆ†
        if(o === pair[1]) this.temp.pkMyScore += 10;
        // ç”µè„‘éšæœºå¾—åˆ† (70%èƒœç‡)
        if(Math.random() < 0.7) this.temp.pkOpScore += 10;
        this.nextPKRound();
      };
      div.appendChild(btn);
    });
  },

  // --- å•†åº—é€»è¾‘ ---
  openShop: function() {
    document.querySelectorAll(".card").forEach(el => el.classList.add("hidden"));
    document.getElementById("shopPage").classList.remove("hidden");
    const list = document.getElementById("medicineList");
    list.innerHTML = "";
    
    Object.keys(DISEASES).forEach(k => {
      const btn = document.createElement("button");
      btn.innerText = `ğŸ’Š æ²»ç–— ${DISEASES[k]}`;
      btn.onclick = () => {
        if(this.state.score < 5) return alert("ç§¯åˆ†ä¸è¶³ï¼");
        if(this.state.mood === "healthy") return alert("å°ç‹—æ²¡ç—…ï¼");
        if(this.state.disease !== k) return alert("è¯ä¸å¯¹ç—‡ï¼");
        
        this.state.score -= 5;
        this.state.mood = "healthy";
        this.state.disease = null;
        this.state.cured++;
        alert("åº·å¤äº†ï¼");
        this.save();
        this.goHome();
      };
      list.appendChild(btn);
    });
  },

  // --- è®¾è®¡é€»è¾‘ ---
  openDesign: function() {
    document.querySelectorAll(".card").forEach(el => el.classList.add("hidden"));
    document.getElementById("designPage").classList.remove("hidden");
    // åŠ è½½å½“å‰æ ·å¼åˆ°æ»‘å—
    document.getElementById("set_color").value = this.state.style.color;
    document.getElementById("set_earL").value = this.state.style.earL;
    document.getElementById("set_earR").value = this.state.style.earR;
    document.getElementById("set_eyeL").value = this.state.style.eyeL;
    document.getElementById("set_eyeR").value = this.state.style.eyeR;
  },

  previewDesign: function() {
    const s = {
      color: document.getElementById("set_color").value,
      earL: document.getElementById("set_earL").value,
      earR: document.getElementById("set_earR").value,
      eyeL: document.getElementById("set_eyeL").value,
      eyeR: document.getElementById("set_eyeR").value
    };
    this.renderDog(s);
  },

  saveDesign: function() {
    if(this.state.score < 2) return alert("ç§¯åˆ†ä¸è¶³ (éœ€è¦2åˆ†)");
    const name = document.getElementById("designName").value || "æœªå‘½å";
    const s = {
      name: name,
      color: document.getElementById("set_color").value,
      earL: document.getElementById("set_earL").value,
      earR: document.getElementById("set_earR").value,
      eyeL: document.getElementById("set_eyeL").value,
      eyeR: document.getElementById("set_eyeR").value
    };
    this.state.designs.push(s);
    this.state.style = s; // åº”ç”¨
    this.state.score -= 2;
    this.save();
    alert("ä¿å­˜æˆåŠŸï¼");
  },

  showGallery: function() {
    document.getElementById("designPage").classList.add("hidden");
    document.getElementById("galleryPage").classList.remove("hidden");
    const grid = document.getElementById("galleryGrid");
    grid.innerHTML = "";
    this.state.designs.forEach((d, i) => {
      const div = document.createElement("div");
      div.className = "design-item";
      div.innerHTML = `<div style="width:30px;height:30px;background:${d.color};border-radius:50%;margin:auto"></div><div>${d.name}</div>`;
      div.onclick = () => {
        this.state.style = d;
        this.save();
        alert("å·²åº”ç”¨æ ·å¼");
        this.applyDogStyle();
      };
      grid.appendChild(div);
    });
  },

  applyDogStyle: function() {
    this.renderDog(this.state.style);
  },

  renderDog: function(s) {
    document.getElementById("dog").style.setProperty('--dogColor', s.color);
    document.getElementById("earL_g").style.transform = `rotate(${s.earL}deg)`;
    document.getElementById("earR_g").style.transform = `rotate(${s.earR}deg)`;
    document.getElementById("eyeL_g").style.transform = `rotate(${s.eyeL}deg)`;
    document.getElementById("eyeR_g").style.transform = `rotate(${s.eyeR}deg)`;
  },

  // --- æˆå°±ä¸ç»Ÿè®¡ ---
  checkAchievements: function() {
    ACHIEVEMENTS.forEach(a => {
      if(!this.state.unlockedAch.includes(a.id) && a.check(this.state)) {
        this.state.unlockedAch.push(a.id);
        alert(`ğŸ† è§£é”æˆå°±ï¼š${a.name}`);
      }
    });
  },

  openAchievements: function() {
    document.querySelectorAll(".card").forEach(el => el.classList.add("hidden"));
    document.getElementById("achievementPage").classList.remove("hidden");
    const list = document.getElementById("achieveList");
    list.innerHTML = "";
    ACHIEVEMENTS.forEach(a => {
      const isUnlock = this.state.unlockedAch.includes(a.id);
      list.innerHTML += `
        <div style="background:${isUnlock?'#ffd700':'#eee'};padding:10px;border-radius:8px;opacity:${isUnlock?1:0.5}">
          <div style="font-weight:bold">${a.name}</div>
          <div style="font-size:12px">${a.desc}</div>
        </div>
      `;
    });
  },

  openStats: function() {
    document.querySelectorAll(".card").forEach(el => el.classList.add("hidden"));
    document.getElementById("statsPage").classList.remove("hidden");
    const c = document.getElementById("statsContent");
    const rate = this.state.total ? Math.round(this.state.correct/this.state.total*100) : 0;
    c.innerHTML = `
      <div class="stat-row"><span>æ€»ç­”é¢˜</span><span>${this.state.total}</span></div>
      <div class="stat-row"><span>æ­£ç¡®ç‡</span><span>${rate}%</span></div>
      <div class="stat-row"><span>æœ€é«˜è¿èƒœ</span><span>${this.state.maxStreak}</span></div>
      <div class="stat-row"><span>æ²»æ„ˆæ¬¡æ•°</span><span>${this.state.cured}</span></div>
    `;
  },

  resetData: function() {
    if(confirm("ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) {
      localStorage.removeItem("DOG_GAME_V2");
      location.reload();
    }
  },

  updateUI: function() {
    document.getElementById("scoreBadge").innerText = `ğŸ’° ${this.state.score}`;
    document.getElementById("streakBadge").innerText = `ğŸ”¥ ${this.state.streak}`;
    const hBtn = document.getElementById("healthBadge");
    if(this.state.mood === "sick") {
      hBtn.innerText = `ğŸ¤’ ${DISEASES[this.state.disease]}`;
      hBtn.style.color = "red";
      document.getElementById("dog").classList.add("sick");
    } else {
      hBtn.innerText = "â¤ï¸ å¥åº·";
      hBtn.style.color = "green";
      document.getElementById("dog").classList.remove("sick");
    }
  }
};

// å¯åŠ¨ç¨‹åº
app.init();

</script>
</body>
</html>
