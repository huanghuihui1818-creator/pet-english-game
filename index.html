<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è‹±è¯­å°ç‹— Â· å®¶åº­ç»ˆæç‰ˆ</title>

<style>
body{
  margin:0;
  font-family:"Comic Sans MS","PingFang SC",sans-serif;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  min-height:100vh;
  text-align:center;
  padding:20px 0;
  color:#333;
}
h1{margin:8px;color:#fff;text-shadow:2px 2px 4px rgba(0,0,0,0.3)}
.hidden{display:none!important}

/* ===== å¡ç‰‡ ===== */
.card{
  background:#fff;border-radius:18px;
  padding:20px;max-width:440px;
  margin:10px auto;
  box-shadow:0 8px 24px rgba(0,0,0,.2);
}
button{
  width:100%;padding:14px;
  margin:6px 0;font-size:16px;
  border:none;border-radius:12px;
  background:#4caf50;color:#fff;
  cursor:pointer;
  transition:all 0.3s;
  font-weight:bold;
}
button:hover{transform:translateY(-2px);box-shadow:0 4px 8px rgba(0,0,0,0.2)}
button:active{transform:translateY(0)}
.secondary{background:#2196f3}
.shop{background:#ff9800}
.back{background:#9e9e9e}
.design{background:#e91e63}
.achievement{background:#9c27b0}
input[type=range]{width:90%;margin:8px 0}
input[type=color]{margin:6px;width:60px;height:40px;border:none;border-radius:8px;cursor:pointer}
input[type=text]{
  width:90%;padding:12px;margin:8px 0;
  border:2px solid #ddd;border-radius:8px;
  font-size:16px;
}

/* ===== å°ç‹—å®¹å™¨ ===== */
.pet-wrap{
  position:relative;
  margin:20px auto;
  width:320px;
  height:380px;
  display:flex;
  justify-content:center;
  align-items:center;
}
.pet{
  width:280px;height:360px;
  transition:transform .3s;
  filter:drop-shadow(0 4px 8px rgba(0,0,0,0.15));
}
.pet.happy{transform:translateY(-12px) scale(1.05)}
.pet.sick{filter:drop-shadow(0 4px 8px rgba(0,0,0,0.15)) grayscale(0.8) sepia(0.2);}

/* ===== æŒ–ç©ºåŠ¨ç”» ===== */
.blank{
  display:inline-block;
  width:24px;
  border-bottom:3px solid #333;
  margin:0 2px;
  animation:pulse .8s infinite alternate;
}
@keyframes pulse{
  from{opacity:.4}
  to{opacity:1}
}
.letter-btn{
  width:auto;
  display:inline-block;
  margin:4px;
  padding:12px 18px;
  font-size:18px;
  font-weight:bold;
  background: #673ab7;
}

/* ===== è®¾è®¡é¢æ¿ ===== */
.design-controls{
  text-align:left;
  margin:10px 0;
}
.design-controls label{
  display:block;
  margin:12px 0 4px 0;
  font-weight:bold;
  color:#333;
}
.range-value{
  display:inline-block;
  margin-left:10px;
  color:#666;
  font-weight:bold;
}

/* ===== è®¾è®¡åº“ ===== */
.design-gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
  gap:10px;
  margin:15px 0;
  max-height:400px;
  overflow-y:auto;
}
.design-item{
  background:#f5f5f5;
  border-radius:12px;
  padding:10px;
  cursor:pointer;
  transition:all 0.3s;
  border:3px solid transparent;
}
.design-item:hover{
  border-color:#e91e63;
  transform:scale(1.05);
}
.design-item svg{
  width:100%;
  height:auto;
}
.design-name{
  font-size:12px;
  margin-top:5px;
  color:#666;
}
.delete-btn{
  background:#f44336;
  padding:4px 8px;
  font-size:12px;
  margin-top:4px;
}

/* ===== çŠ¶æ€æ˜¾ç¤º ===== */
#status, #score{
  background:rgba(255,255,255,0.9);
  display:inline-block;
  padding:10px 20px;
  border-radius:20px;
  margin:5px;
  font-weight:bold;
  color:#333;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}

/* ===== æˆå°±ç³»ç»Ÿ ===== */
.achievements{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(100px,1fr));
  gap:10px;
  margin:15px 0;
}
.achievement-item{
  background:#f5f5f5;
  border-radius:12px;
  padding:15px 10px;
  text-align:center;
  transition:all 0.3s;
  opacity: 0.5;
}
.achievement-item.unlocked{
  background:linear-gradient(135deg,#ffd700,#ffed4e);
  transform:scale(1.05);
  opacity: 1;
  box-shadow: 0 4px 10px rgba(255, 215, 0, 0.4);
}
.achievement-icon{
  font-size:32px;
  margin-bottom:5px;
}
.achievement-name{
  font-size:12px;
  color:#666;
}
.achievement-item.unlocked .achievement-name{
  color:#333;
  font-weight:bold;
}

/* ===== å¥½å‹å¯¹æˆ˜ ===== */
.battle-zone{
  background:#f9f9f9;
  border-radius:12px;
  padding:15px;
  margin:10px 0;
}
.vs{
  font-size:24px;
  font-weight:bold;
  color:#ff5722;
  margin:10px 0;
}

/* ===== ç»Ÿè®¡é¢æ¿ ===== */
.stats{
  text-align:left;
  background:#f5f5f5;
  padding:15px;
  border-radius:12px;
  margin:10px 0;
}
.stat-row{
  display:flex;
  justify-content:space-between;
  margin:8px 0;
  padding:8px;
  background:#fff;
  border-radius:8px;
}
</style>
</head>

<body>

<h1>ğŸ¶ æˆ‘çš„è‹±è¯­å°ç‹—</h1>

<div class="pet-wrap">
<svg id="dog" class="pet" viewBox="0 0 200 360">
  <ellipse cx="100" cy="200" rx="65" ry="90" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="3"/>
   
  <circle cx="100" cy="100" r="55" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="3"/>
   
  <g id="earL_g" transform-origin="55 65">
    <ellipse cx="55" cy="65" rx="18" ry="38" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
    <ellipse cx="55" cy="70" rx="10" ry="20" fill="#ffb6c1"/>
  </g>
   
  <g id="earR_g" transform-origin="145 65">
    <ellipse cx="145" cy="65" rx="18" ry="38" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
    <ellipse cx="145" cy="70" rx="10" ry="20" fill="#ffb6c1"/>
  </g>
   
  <g id="eyeL_g" transform-origin="85 95">
    <ellipse cx="85" cy="95" rx="8" ry="10" fill="#fff" stroke="#333" stroke-width="1"/>
    <circle cx="85" cy="97" r="5" fill="#000"/>
    <circle cx="86" cy="95" r="2" fill="#fff"/>
  </g>
   
  <g id="eyeR_g" transform-origin="115 95">
    <ellipse cx="115" cy="95" rx="8" ry="10" fill="#fff" stroke="#333" stroke-width="1"/>
    <circle cx="115" cy="97" r="5" fill="#000"/>
    <circle cx="116" cy="95" r="2" fill="#fff"/>
  </g>
   
  <ellipse cx="100" cy="115" rx="8" ry="6" fill="#000"/>
   
  <path d="M88 125 Q100 135 112 125" stroke="#000" stroke-width="3" fill="none"/>
   
  <rect x="70" y="270" width="12" height="70" rx="6" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
  <rect x="118" y="270" width="12" height="70" rx="6" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
   
  <rect x="55" y="270" width="12" height="70" rx="6" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
  <rect x="133" y="270" width="12" height="70" rx="6" fill="var(--dogColor,#fff)" stroke="#888" stroke-width="2"/>
   
  <path d="M155 210 Q175 200 180 180" stroke="var(--dogColor,#fff)" stroke-width="15" fill="none" stroke-linecap="round"/>
   
  <g id="accessory">
    <rect x="75" y="145" width="50" height="8" rx="4" fill="#ff1744"/>
    <circle cx="100" cy="149" r="5" fill="#ffd700" stroke="#ff1744" stroke-width="2"/>
  </g>
</svg>
</div>

<div id="status"></div>
<div id="score"></div>
<div id="streak" style="background:rgba(255,255,255,0.9);display:inline-block;padding:8px 16px;border-radius:20px;margin:5px;font-weight:bold;color:#ff5722"></div>

<div class="card" id="home">
  <button onclick="enterStudy()">ğŸ“˜ å­¦ä¹ æ¨¡å¼</button>
  <button class="secondary" onclick="enterCheckup()">ğŸ¥ ä½“æ£€ï¼ˆ10é¢˜ï¼‰</button>
  <button onclick="enterPK()">âš”ï¸ PK å¯¹æˆ˜</button>
  <button class="shop" onclick="openShop()">ğŸ’Š è¯å“å•†åº—</button>
  <button class="design" onclick="openDesign()">ğŸ¨ è®¾è®¡å°ç‹—</button>
  <button class="achievement" onclick="openAchievements()">ğŸ† æˆå°±ç³»ç»Ÿ</button>
  <button class="secondary" onclick="openStats()">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</button>
</div>

<div class="card hidden" id="quiz">
  <div id="quizTitle" style="font-size:20px;font-weight:bold;margin-bottom:15px"></div>
  <div id="question" style="font-size:18px;margin:15px 0;color:#333"></div>

  <div id="choices">
    <button onclick="choose(0)" id="c0"></button>
    <button onclick="choose(1)" id="c1"></button>
  </div>

  <div id="spell" class="hidden">
    <div id="spellHint" style="margin:10px 0;font-size:16px;color:#666"></div>
    <input type="text" id="spellInput" placeholder="è¯·è¾“å…¥è‹±æ–‡æ‹¼å†™">
    <button onclick="spellCheck()">âœ… æäº¤ç­”æ¡ˆ</button>
  </div>

  <div id="blank" class="hidden">
    <div id="blankWord" style="font-size:24px;margin:15px 0;letter-spacing:2px"></div>
    <div id="letters"></div>
  </div>

  <button class="back" onclick="backHome()">â¬… è¿”å›ä¸»é¡µ</button>
</div>

<div class="card hidden" id="pkMode">
  <h3 style="color:#ff5722">âš”ï¸ PK å¯¹æˆ˜æ¨¡å¼</h3>
  <div class="battle-zone">
    <div>ä½ ï¼š<span id="myPKScore">0</span> åˆ†</div>
    <div class="vs">VS</div>
    <div>å¯¹æ‰‹ï¼š<span id="opponentPKScore">0</span> åˆ†</div>
  </div>
  <div id="pkQuestion" style="margin:15px 0;font-size:18px"></div>
  <div id="pkChoices">
    <button onclick="pkChoose(0)" id="pk0"></button>
    <button onclick="pkChoose(1)" id="pk1"></button>
  </div>
  <div id="pkResult" style="margin:10px 0;font-weight:bold"></div>
  <button class="back" onclick="backHome()">â¬… è¿”å›ä¸»é¡µ</button>
</div>

<div class="card hidden" id="shop">
  <h3 style="color:#ff9800">ğŸ’Š è¯å“å•†åº—ï¼ˆ5 ç§¯åˆ† / ä¸ªï¼‰</h3>
  <p style="color:#666;font-size:14px">è¯·æ ¹æ®ç—‡çŠ¶è´­ä¹°å¯¹åº”çš„è¯å“</p>
  <button onclick="buyMedicine('headache')">ğŸ’Š å¤´ç—›è¯ (Headache)</button>
  <button onclick="buyMedicine('toothache')">ğŸ’Š ç‰™ç—›è¯ (Toothache)</button>
  <button onclick="buyMedicine('stomach-ache')">ğŸ’Š èƒƒç—›è¯ (Stomach-ache)</button>
  <button onclick="buyMedicine('backache')">ğŸ’Š èƒŒç—›è¯ (Backache)</button>
  <button onclick="buyMedicine('cold')">ğŸ’Š æ„Ÿå†’è¯ (Cold)</button>
  <button onclick="buyMedicine('hurt')">ğŸ’Š å¤–ä¼¤è¯ (Hurt)</button>
  <button class="back" onclick="closeShop()">â¬… è¿”å›</button>
</div>

<div class="card hidden" id="designPanel">
  <h3 style="color:#e91e63">ğŸ¨ è®¾è®¡ä½ çš„å°ç‹—ï¼ˆ2 ç§¯åˆ†ï¼‰</h3>
   
  <div class="design-controls">
    <label>ğŸ¨ å°ç‹—é¢œè‰²:</label>
    <input type="color" id="colorPicker" value="#ffffff" oninput="previewDesign()">
     
    <label>ğŸ‘‚ å·¦è€³è§’åº¦: <span class="range-value" id="earLVal">0Â°</span></label>
    <input type="range" id="earLAngle" min="-45" max="45" value="0" step="1" oninput="previewDesign()">
     
    <label>ğŸ‘‚ å³è€³è§’åº¦: <span class="range-value" id="earRVal">0Â°</span></label>
    <input type="range" id="earRAngle" min="-45" max="45" value="0" step="1" oninput="previewDesign()">
     
    <label>ğŸ‘ï¸ å·¦çœ¼è§’åº¦: <span class="range-value" id="eyeLVal">0Â°</span></label>
    <input type="range" id="eyeLAngle" min="-20" max="20" value="0" step="1" oninput="previewDesign()">
     
    <label>ğŸ‘ï¸ å³çœ¼è§’åº¦: <span class="range-value" id="eyeRVal">0Â°</span></label>
    <input type="range" id="eyeRAngle" min="-20" max="20" value="0" step="1" oninput="previewDesign()">
     
    <label>ğŸ’¾ è®¾è®¡åç§°:</label>
    <input type="text" id="designName" placeholder="ç»™ä½ çš„è®¾è®¡èµ·ä¸ªåå­—">
  </div>
   
  <button onclick="saveDesign()">ğŸ’¾ ä¿å­˜åˆ°è®¾è®¡åº“ï¼ˆ-2ç§¯åˆ†ï¼‰</button>
  <button class="secondary" onclick="viewGallery()">ğŸ–¼ï¸ æŸ¥çœ‹è®¾è®¡åº“</button>
  <button class="back" onclick="closeDesign()">â¬… è¿”å›</button>
</div>

<div class="card hidden" id="gallery">
  <h3 style="color:#e91e63">ğŸ–¼ï¸ æˆ‘çš„è®¾è®¡åº“</h3>
  <div id="galleryGrid" class="design-gallery"></div>
  <button class="back" onclick="closeGallery()">â¬… è¿”å›è®¾è®¡</button>
</div>

<div class="card hidden" id="achievementPanel">
  <h3 style="color:#9c27b0">ğŸ† æˆå°±ç³»ç»Ÿ</h3>
  <div class="achievements" id="achievementList"></div>
  <button class="back" onclick="closeAchievements()">â¬… è¿”å›</button>
</div>

<div class="card hidden" id="statsPanel">
  <h3 style="color:#2196f3">ğŸ“Š å­¦ä¹ ç»Ÿè®¡</h3>
  <div class="stats" id="statsList"></div>
  <button onclick="resetStats()" style="background:#f44336">ğŸ”„ é‡ç½®æ‰€æœ‰æ•°æ®</button>
  <button class="back" onclick="closeStats()">â¬… è¿”å›</button>
</div>

<script>
/* ===== å®Œæ•´è¯åº“ ===== */
const WORD_GROUPS = {
  headache: [
    ["practice","ç»ƒä¹ "],["prepare","å‡†å¤‡"],["brain","å¤§è„‘"],
    ["think","æ€è€ƒ"],["sense","æ„Ÿè§‰"],["balance","å¹³è¡¡"],
    ["control","æ§åˆ¶"],["complicated","å¤æ‚çš„"],["organ","å™¨å®˜"],
    ["without","æ²¡æœ‰"]
  ],
  toothache: [
    ["eat","åƒ"],["toothache","ç‰™ç—›"],["cough","å’³å—½"],
    ["hurt","å—ä¼¤"],["sore","ç–¼ç—›çš„"],["knock","æ•²"],
    ["roar","å¼å«"],["greedy","è´ªå©ªçš„"],["belong","å±äº"],
    ["touch","è§¦æ‘¸"]
  ],
  "stomach-ache": [
    ["stomach","èƒƒ"],["stomach-ache","èƒƒç—›"],["breathe","å‘¼å¸"],
    ["calm","å¹³é™çš„"],["character","æ€§æ ¼"],["poor","è´«ç©·çš„"],
    ["porridge","ç²¥"],["wild","é‡ç”Ÿçš„"],["collect","æ”¶é›†"],
    ["firewood","æŸ´ç«"]
  ],
  backache: [
    ["backache","èƒŒç—›"],["weekly","æ¯å‘¨çš„"],["stretch","ä¼¸å±•"],
    ["schedule","å®‰æ’"],["second","ç¬¬äºŒï¼›ç§’"],["odd","å¥‡æ€ªçš„"],
    ["warm","æ¸©æš–"],["present","ç°åœ¨çš„"],["start","å¼€å§‹"],
    ["begin","å¼€å§‹"]
  ],
  cold: [
    ["cold","æ„Ÿå†’"],["healthy","å¥åº·çš„"],["temperature","ä½“æ¸©"],
    ["dangerous","å±é™©çš„"],["country","å›½å®¶"],["brilliant","èªæ˜çš„"],
    ["video","è§†é¢‘"],["nature","è‡ªç„¶"],["natural","è‡ªç„¶çš„"],
    ["naturally","è‡ªç„¶åœ°"]
  ],
  hurt: [
    ["hurt","å—ä¼¤"],["headache","å¤´ç—›"],["throat","å–‰å’™"],
    ["design","è®¾è®¡"],["place","åœ°æ–¹"],["create","åˆ›é€ "],
    ["adventure","å†’é™©"],["map","åœ°å›¾"],["area","åŒºåŸŸ"],
    ["invent","å‘æ˜"]
  ],
  general: [
    ["fantastic","æå¥½çš„"],["exciting","ä»¤äººå…´å¥‹çš„"],["ago","ä»¥å‰"],
    ["town","åŸé•‡"],["cry","å“­"],["leave","ç¦»å¼€"],["travel","æ—…è¡Œ"],
    ["until","ç›´åˆ°"],["terrible","å¯æ€•çš„"],["plan","è®¡åˆ’"],
    ["gold","é‡‘å­"],["golden","é‡‘è‰²çš„"],["costume","æœè£…"],
    ["catch","æŠ“ä½"],["palace","å®«æ®¿"],["use","ä½¿ç”¨"],
    ["find","æ‰¾åˆ°"],["think","æ€è€ƒ"],["insect","æ˜†è™«"],
    ["tiny","å¾®å°çš„"],["land","é™†åœ°"],["large","å¤§çš„"],
    ["island","å²›å±¿"],["unit","å•å…ƒ"]
  ]
};

const DISEASES = ["headache","toothache","stomach-ache","backache","cold","hurt"];

const DISEASE_NAMES = {
  headache: "å¤´ç—›",
  toothache: "ç‰™ç—›",
  "stomach-ache": "èƒƒç—›",
  backache: "èƒŒç—›",
  cold: "æ„Ÿå†’",
  hurt: "å¤–ä¼¤"
};

/* ===== æˆå°±å®šä¹‰ ===== */
const ACHIEVEMENTS = [
  {id:"first_answer",name:"åˆæ¬¡å°è¯•",icon:"ğŸ¯",desc:"ç­”å¯¹ç¬¬ä¸€é¢˜",check:s=>s.correctCount>=1},
  {id:"score_10",name:"å…¥é—¨å­¦è€…",icon:"ğŸ“š",desc:"è·å¾—10ç§¯åˆ†",check:s=>s.score>=10},
  {id:"score_50",name:"å‹¤å¥‹å­¦ç”Ÿ",icon:"âœ¨",desc:"è·å¾—50ç§¯åˆ†",check:s=>s.score>=50},
  {id:"score_100",name:"å­¦éœ¸",icon:"ğŸ‘‘",desc:"è·å¾—100ç§¯åˆ†",check:s=>s.score>=100},
  {id:"streak_5",name:"è¿èƒœç‹",icon:"ğŸ”¥",desc:"è¿ç»­ç­”å¯¹5é¢˜",check:s=>s.streak>=5},
  {id:"streak_10",name:"æ— æ•Œ",icon:"âš¡",desc:"è¿ç»­ç­”å¯¹10é¢˜",check:s=>s.streak>=10},
  {id:"design_1",name:"è®¾è®¡å¸ˆ",icon:"ğŸ¨",desc:"ä¿å­˜ç¬¬ä¸€ä¸ªè®¾è®¡",check:s=>s.designs.length>=1},
  {id:"design_5",name:"åˆ›æ„å¤§å¸ˆ",icon:"ğŸ–Œï¸",desc:"ä¿å­˜5ä¸ªè®¾è®¡",check:s=>s.designs.length>=5},
  {id:"cure_1",name:"åº·å¤ä¸“å®¶",icon:"ğŸ’Š",desc:"æ²»æ„ˆå°ç‹—1æ¬¡",check:s=>s.cureCount>=1},
  {id:"cure_5",name:"ååŒ»",icon:"âš•ï¸",desc:"æ²»æ„ˆå°ç‹—5æ¬¡",check:s=>s.cureCount>=5},
  {id:"total_100",name:"ç™¾é¢˜è¾¾äºº",icon:"ğŸ’¯",desc:"ç´¯è®¡ç­”é¢˜100é“",check:s=>s.totalAnswered>=100},
  {id:"pk_win_5",name:"å¯¹æˆ˜é«˜æ‰‹",icon:"âš”ï¸",desc:"PKèµ¢5æ¬¡",check:s=>s.pkWins>=5}
];

/* ===== çŠ¶æ€ ===== */
let state = JSON.parse(localStorage.getItem("DOG_APP")) || {
  score: 0,
  mood: "healthy",
  disease: null,
  color: "#ffffff",
  earL: 0,
  earR: 0,
  eyeL: 0,
  eyeR: 0,
  designs: [],
  achievements: [],
  streak: 0,
  maxStreak: 0,
  correctCount: 0,
  wrongCount: 0,
  totalAnswered: 0,
  cureCount: 0,
  pkWins: 0,
  pkLosses: 0
};

let mode = "study";
let checkupCount = 0;
let currentWords = [];
let pkRound = 0;
let pkMyScore = 0;
let pkOpponentScore = 0;
let current, modeQ, opts = [], blankIdx;
let pkCurrent, pkOpts = [];

function save() {
  localStorage.setItem("DOG_APP", JSON.stringify(state));
  updateUI();
}

/* ===== é¡µé¢åˆ‡æ¢ ===== */
function enterStudy() {
  mode = "study";
  currentWords = getAllWords();
  document.getElementById("quizTitle").innerText = "ğŸ“˜ å­¦ä¹ æ¨¡å¼";
  document.getElementById("home").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");
  next();
}

function enterCheckup() {
  if (state.mood !== "sick") {
    alert("å°ç‹—å¾ˆå¥åº·ï¼Œä¸éœ€è¦ä½“æ£€ï¼");
    return;
  }
  mode = "checkup";
  checkupCount = 0;
  currentWords = WORD_GROUPS[state.disease].map(w => ({en: w[0], cn: w[1]}));
  document.getElementById("quizTitle").innerText = `ğŸ¥ ä½“æ£€ä¸­ï¼ˆ${DISEASE_NAMES[state.disease]}ï¼‰`;
  document.getElementById("home").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");
  next();
}

function enterPK() {
  pkRound = 0;
  pkMyScore = 0;
  pkOpponentScore = 0;
  currentWords = getAllWords();
  document.getElementById("home").classList.add("hidden");
  document.getElementById("pkMode").classList.remove("hidden");
  updatePKUI();
  pkNext();
}

function backHome() {
  document.getElementById("quiz").classList.add("hidden");
  document.getElementById("shop").classList.add("hidden");
  document.getElementById("designPanel").classList.add("hidden");
  document.getElementById("gallery").classList.add("hidden");
  document.getElementById("achievementPanel").classList.add("hidden");
  document.getElementById("statsPanel").classList.add("hidden");
  document.getElementById("pkMode").classList.add("hidden");
  document.getElementById("home").classList.remove("hidden");
  updateUI();
}

function openShop() {
  document.getElementById("home").classList.add("hidden");
  document.getElementById("shop").classList.remove("hidden");
}

function closeShop() {
  document.getElementById("shop").classList.add("hidden");
  document.getElementById("home").classList.remove("hidden");
}

function openDesign() {
  document.getElementById("home").classList.add("hidden");
  document.getElementById("designPanel").classList.remove("hidden");
  loadCurrentDesign();
}

function closeDesign() {
  document.getElementById("designPanel").classList.add("hidden");
  document.getElementById("home").classList.remove("hidden");
  updateDog();
}

function viewGallery() {
  document.getElementById("designPanel").classList.add("hidden");
  document.getElementById("gallery").classList.remove("hidden");
  renderGallery();
}

function closeGallery() {
  document.getElementById("gallery").classList.add("hidden");
  document.getElementById("designPanel").classList.remove("hidden");
}

function openAchievements() {
  document.getElementById("home").classList.add("hidden");
  document.getElementById("achievementPanel").classList.remove("hidden");
  renderAchievements();
}

function closeAchievements() {
  document.getElementById("achievementPanel").classList.add("hidden");
  document.getElementById("home").classList.remove("hidden");
}

function openStats() {
  document.getElementById("home").classList.add("hidden");
  document.getElementById("statsPanel").classList.remove("hidden");
  renderStats();
}

function closeStats() {
  document.getElementById("statsPanel").classList.add("hidden");
  document.getElementById("home").classList.remove("hidden");
}

/* ===== å·¥å…·å‡½æ•° ===== */
function getAllWords() {
  let all = [];
  for (let disease in WORD_GROUPS) {
    all = all.concat(WORD_GROUPS[disease].map(w => ({en: w[0], cn: w[1]})));
  }
  return all;
}

/* ===== å‡ºé¢˜é€»è¾‘ ===== */
function next() {
  document.getElementById("spellInput").value = "";
  document.getElementById("choices").classList.remove("hidden");
  document.getElementById("spell").classList.add("hidden");
  document.getElementById("blank").classList.add("hidden");

  if (currentWords.length === 0) currentWords = getAllWords();
  
  current = currentWords[Math.floor(Math.random() * currentWords.length)];
  const r = Math.random();
  if (r < 0.33) modeQ = "choice";
  else if (r < 0.66) modeQ = "spell";
  else modeQ = "blank";

  // 1. é€‰æ‹©é¢˜
  if (modeQ === "choice") {
    const wrong = currentWords[Math.floor(Math.random() * currentWords.length)];
    const en2cn = Math.random() < 0.5;
    document.getElementById("question").innerText = en2cn 
      ? `"${current.en}" æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ`
      : `"${current.cn}" ç”¨è‹±æ–‡æ€ä¹ˆè¯´ï¼Ÿ`;
    const correct = en2cn ? current.cn : current.en;
    const wrongAns = en2cn ? wrong.cn : wrong.en;
    opts = [correct, wrongAns === correct ? "é”™è¯¯é€‰é¡¹" : wrongAns].sort(() => Math.random() - 0.5);
    document.getElementById("c0").innerText = opts[0];
    document.getElementById("c1").innerText = opts[1];
    document.getElementById("c0").onclick = () => choose(0);
    document.getElementById("c1").onclick = () => choose(1);
  }
  // 2. æ‹¼å†™é¢˜
  else if (modeQ === "spell") {
    document.getElementById("choices").classList.add("hidden");
    document.getElementById("spell").classList.remove("hidden");
    document.getElementById("question").innerText = "æ‹¼å†™å•è¯";
    document.getElementById("spellHint").innerText = "ä¸­æ–‡æç¤ºï¼š" + current.cn;
  }
  // 3. å¡«ç©ºé¢˜
  else {
    document.getElementById("choices").classList.add("hidden");
    document.getElementById("blank").classList.remove("hidden");
    document.getElementById("question").innerText = "è¡¥å…¨å•è¯";
    const w = current.en;
    blankIdx = Math.floor(Math.random() * w.length); // éšæœºæŒ–ç©º
    document.getElementById("blankWord").innerHTML = w.split("").map((c, i) => 
      i === blankIdx ? '<span class="blank"></span>' : c
    ).join("");
    document.getElementById("letters").innerHTML = "";
    
    const correct = w[blankIdx];
    let wrong = String.fromCharCode(97 + Math.floor(Math.random() * 26));
    while(wrong === correct) wrong = String.fromCharCode(97 + Math.floor(Math.random() * 26));

    [correct, wrong].sort(() => Math.random() - 0.5).forEach(l => {
      const b = document.createElement("button");
      b.className = "letter-btn";
      b.innerText = l;
      b.onclick = () => checkAns(l === correct); // ä¿®å¤äº†è¿™é‡Œ
      document.getElementById("letters").appendChild(b);
    });
  }
}

function choose(idx) {
  const en2cn = document.getElementById("question").innerText.includes("æ„æ€");
  const correct = en2cn ? current.cn : current.en;
  checkAns(opts[idx] === correct);
}

function spellCheck() {
  const input = document.getElementById("spellInput").value.trim().toLowerCase();
  checkAns(input === current.en.toLowerCase());
}

/* ===== æ ¸å¿ƒåˆ¤æ–­é€»è¾‘ ===== */
function checkAns(isCorrect) {
  state.totalAnswered++;
  
  if (isCorrect) {
    state.score++;
    state.streak++;
    state.correctCount++;
    if(state.streak > state.maxStreak) state.maxStreak = state.streak;
    
    // ç‹—å¼€å¿ƒåŠ¨ç”»
    const dog = document.getElementById("dog");
    dog.classList.add("happy");
    setTimeout(() => dog.classList.remove("happy"), 500);
    
    alert("âœ… ç­”å¯¹äº†ï¼");
  } else {
    state.streak = 0;
    state.wrongCount++;
    alert(`âŒ ç­”é”™äº†ï¼æ­£ç¡®ç­”æ¡ˆæ˜¯ï¼š${current.en} (${current.cn})`);
    
    // éšæœºç”Ÿç—…
    if (state.mood === "healthy" && Math.random() < 0.2) {
      makeSick();
    }
  }

  // ä½“æ£€æ¨¡å¼é€»è¾‘
  if (mode === "checkup") {
    checkupCount++;
    if (checkupCount >= 10) {
      if (state.streak >= 8) { // ç®€å•åˆ¤æ–­ï¼Œè¿™é‡Œç”¨ streak ä»£è¡¨æœ€åå‡ é¢˜è¡¨ç°
        alert("ğŸ‰ ä½“æ£€é€šè¿‡ï¼å°ç‹—åº·å¤äº†ï¼");
        state.mood = "healthy";
        state.disease = null;
        state.cureCount++;
        backHome();
      } else {
        alert("âš ï¸ ä½“æ£€æœªé€šè¿‡ï¼Œè¯·ç»§ç»­åƒè¯æˆ–å­¦ä¹ ï¼");
        backHome();
      }
    } else {
      next();
    }
  } else {
    next();
  }
  
  checkAchievements();
  save();
}

function makeSick() {
  state.mood = "sick";
  state.disease = DISEASES[Math.floor(Math.random() * DISEASES.length)];
  alert(`ğŸ˜± ç³Ÿç³•ï¼å› ä¸ºç­”é”™é¢˜ï¼Œå°ç‹—å¾—äº† ${DISEASE_NAMES[state.disease]}ï¼\nå¿«å»å•†åº—ä¹°è¯å§ï¼`);
  updateUI();
}

/* ===== PK ç³»ç»Ÿ ===== */
function pkNext() {
  if (pkRound >= 5) {
    let result = "";
    if (pkMyScore > pkOpponentScore) {
      result = "ğŸ† ä½ èµ¢äº†ï¼(+5 ç§¯åˆ†)";
      state.score += 5;
      state.pkWins++;
    } else if (pkMyScore < pkOpponentScore) {
      result = "ğŸ˜¢ ä½ è¾“äº†...";
      state.pkLosses++;
    } else {
      result = "ğŸ¤ å¹³å±€ï¼";
    }
    document.getElementById("pkResult").innerText = result;
    document.getElementById("pkChoices").classList.add("hidden");
    checkAchievements();
    save();
    return;
  }
  
  pkRound++;
  pkCurrent = currentWords[Math.floor(Math.random() * currentWords.length)];
  const wrong = currentWords[Math.floor(Math.random() * currentWords.length)];
  pkOpts = [pkCurrent.cn, wrong.cn].sort(() => Math.random() - 0.5);
  
  document.getElementById("pkQuestion").innerText = `ç¬¬ ${pkRound}/5 è½®: "${pkCurrent.en}" çš„æ„æ€æ˜¯ï¼Ÿ`;
  document.getElementById("pkResult").innerText = "";
  document.getElementById("pk0").innerText = pkOpts[0];
  document.getElementById("pk1").innerText = pkOpts[1];
  document.getElementById("pkChoices").classList.remove("hidden");
}

function pkChoose(idx) {
  const isCorrect = pkOpts[idx] === pkCurrent.cn;
  if (isCorrect) pkMyScore += 10;
  
  // æ¨¡æ‹Ÿå¯¹æ‰‹ (70% èƒœç‡)
  if (Math.random() < 0.7) pkOpponentScore += 10;
  
  updatePKUI();
  pkNext();
}

function updatePKUI() {
  document.getElementById("myPKScore").innerText = pkMyScore;
  document.getElementById("opponentPKScore").innerText = pkOpponentScore;
}

/* ===== å•†åº—ä¸è®¾è®¡ ===== */
function buyMedicine(disease) {
  if (state.score < 5) {
    alert("ğŸ’° ç§¯åˆ†ä¸è¶³ï¼ˆéœ€è¦5ç§¯åˆ†ï¼‰ï¼å¿«å»å­¦ä¹ èµšåˆ†å§ï¼");
    return;
  }
  if (state.mood === "healthy") {
    alert("ğŸ˜Š å°ç‹—å¾ˆå¥åº·ï¼Œä¸éœ€è¦åƒè¯ï¼");
    return;
  }
  if (state.disease !== disease) {
    alert("âŒ ä¹°é”™è¯äº†ï¼è¯·æŸ¥çœ‹å°ç‹—çš„ç—‡çŠ¶ã€‚");
    return;
  }

  state.score -= 5;
  state.mood = "healthy";
  state.disease = null;
  state.cureCount++;
  alert("ğŸ’Š è¯åˆ°ç—…é™¤ï¼å°ç‹—åº·å¤äº†ï¼");
  checkAchievements();
  save();
  closeShop();
}

/* ===== è®¾è®¡é€»è¾‘ ===== */
function previewDesign() {
  const color = document.getElementById("colorPicker").value;
  const earL = document.getElementById("earLAngle").value;
  const earR = document.getElementById("earRAngle").value;
  const eyeL = document.getElementById("eyeLAngle").value;
  const eyeR = document.getElementById("eyeRAngle").value;

  document.getElementById("dog").style.setProperty('--dogColor', color);
  document.getElementById("earL_g").style.transform = `rotate(${earL}deg)`;
  document.getElementById("earR_g").style.transform = `rotate(${earR}deg)`;
  document.getElementById("eyeL_g").style.transform = `rotate(${eyeL}deg)`;
  document.getElementById("eyeR_g").style.transform = `rotate(${eyeR}deg)`;

  document.getElementById("earLVal").innerText = earL + "Â°";
  document.getElementById("earRVal").innerText = earR + "Â°";
  document.getElementById("eyeLVal").innerText = eyeL + "Â°";
  document.getElementById("eyeRVal").innerText = eyeR + "Â°";
}

function loadCurrentDesign() {
  document.getElementById("colorPicker").value = state.color;
  document.getElementById("earLAngle").value = state.earL;
  document.getElementById("earRAngle").value = state.earR;
  document.getElementById("eyeLAngle").value = state.eyeL;
  document.getElementById("eyeRAngle").value = state.eyeR;
  previewDesign();
}

function saveDesign() {
  if (state.score < 2) {
    alert("ğŸ’° ç§¯åˆ†ä¸è¶³ï¼ˆéœ€è¦2ç§¯åˆ†ï¼‰");
    return;
  }
  const name = document.getElementById("designName").value || "æœªå‘½åè®¾è®¡";
  const newDesign = {
    name: name,
    color: document.getElementById("colorPicker").value,
    earL: document.getElementById("earLAngle").value,
    earR: document.getElementById("earRAngle").value,
    eyeL: document.getElementById("eyeLAngle").value,
    eyeR: document.getElementById("eyeRAngle").value
  };

  state.designs.push(newDesign);
  state.score -= 2;
  // åº”ç”¨å½“å‰è®¾è®¡
  state.color = newDesign.color;
  state.earL = newDesign.earL;
  state.earR = newDesign.earR;
  state.eyeL = newDesign.eyeL;
  state.eyeR = newDesign.eyeR;
  
  alert("ğŸ’¾ è®¾è®¡å·²ä¿å­˜å¹¶åº”ç”¨ï¼");
  checkAchievements();
  save();
}

function renderGallery() {
  const grid = document.getElementById("galleryGrid");
  grid.innerHTML = "";
  state.designs.forEach((d, idx) => {
    const item = document.createElement("div");
    item.className = "design-item";
    item.innerHTML = `
      <div style="width:50px;height:50px;background:${d.color};border-radius:50%;margin:0 auto"></div>
      <div class="design-name">${d.name}</div>
      <button class="delete-btn" onclick="applyDesign(${idx})">åº”ç”¨</button>
    `;
    grid.appendChild(item);
  });
}

function applyDesign(idx) {
  const d = state.designs[idx];
  state.color = d.color;
  state.earL = d.earL;
  state.earR = d.earR;
  state.eyeL = d.eyeL;
  state.eyeR = d.eyeR;
  alert("ğŸ¨ å·²åº”ç”¨è®¾è®¡ï¼š" + d.name);
  save();
  closeGallery();
}

/* ===== ç»Ÿè®¡ä¸æˆå°± ===== */
function checkAchievements() {
  let hasNew = false;
  ACHIEVEMENTS.forEach(a => {
    if (!state.achievements.includes(a.id) && a.check(state)) {
      state.achievements.push(a.id);
      alert(`ğŸ† è§£é”æˆå°±ï¼š${a.name}\n${a.desc}`);
      hasNew = true;
    }
  });
  if (hasNew) save();
}

function renderAchievements() {
  const list = document.getElementById("achievementList");
  list.innerHTML = "";
  ACHIEVEMENTS.forEach(a => {
    const unlocked = state.achievements.includes(a.id);
    const div = document.createElement("div");
    div.className = `achievement-item ${unlocked ? "unlocked" : ""}`;
    div.innerHTML = `
      <div class="achievement-icon">${a.icon}</div>
      <div class="achievement-name">${a.name}</div>
      <div style="font-size:10px;color:#888">${unlocked ? "å·²è§£é”" : "???"}</div>
    `;
    list.appendChild(div);
  });
}

function renderStats() {
  const list = document.getElementById("statsList");
  const rate = state.totalAnswered === 0 ? 0 : Math.round((state.correctCount / state.totalAnswered) * 100);
  list.innerHTML = `
    <div class="stat-row"><span>ğŸ“ æ€»ç­”é¢˜æ•°</span><span>${state.totalAnswered}</span></div>
    <div class="stat-row"><span>âœ… æ­£ç¡®ç‡</span><span>${rate}%</span></div>
    <div class="stat-row"><span>ğŸ”¥ æœ€é«˜è¿èƒœ</span><span>${state.maxStreak}</span></div>
    <div class="stat-row"><span>ğŸ’Š æ²»æ„ˆæ¬¡æ•°</span><span>${state.cureCount}</span></div>
    <div class="stat-row"><span>âš”ï¸ PKèƒœåœº</span><span>${state.pkWins}</span></div>
  `;
}

function resetStats() {
  if(confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰è¿›åº¦å—ï¼Ÿ")) {
    localStorage.removeItem("DOG_APP");
    location.reload();
  }
}

/* ===== åˆå§‹åŒ– ===== */
function updateDog() {
  const dog = document.getElementById("dog");
  dog.style.setProperty('--dogColor', state.color);
  document.getElementById("earL_g").style.transform = `rotate(${state.earL}deg)`;
  document.getElementById("earR_g").style.transform = `rotate(${state.earR}deg)`;
  document.getElementById("eyeL_g").style.transform = `rotate(${state.eyeL}deg)`;
  document.getElementById("eyeR_g").style.transform = `rotate(${state.eyeR}deg)`;
  
  if (state.mood === "sick") {
    dog.classList.add("sick");
  } else {
    dog.classList.remove("sick");
  }
}

function updateUI() {
  document.getElementById("score").innerText = "ğŸ’° ç§¯åˆ†: " + state.score;
  document.getElementById("streak").innerText = "ğŸ”¥ è¿èƒœ: " + state.streak;
  
  const status = document.getElementById("status");
  if (state.mood === "healthy") {
    status.innerText = "â¤ï¸ çŠ¶æ€: å¥åº·";
    status.style.color = "green";
  } else {
    status.innerText = `ğŸ¤’ çŠ¶æ€: ç”Ÿç—… (${DISEASE_NAMES[state.disease]})`;
    status.style.color = "red";
  }
  updateDog();
}

// å¯åŠ¨
updateUI();

</script>
</body>
</html>
